<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Token Minting Page</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 50px;
        }
        .card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-mint {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-mint:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
    </style>
</head>
<body onload="checkWallet()">

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title text-center">My Token Minting Page</h1>
                    <form id="mintForm">
                        <div class="form-group">
                            <label for="tokenAmount">How many tokens to mint?</label>
                            <input type="number" class="form-control" id="tokenAmount" name="tokenAmount" min="1" required>
                        </div>
                        <button type="submit" class="btn btn-mint btn-block">Mint</button>
                    </form>
                    <section id="walletInfo" class="mt-4">
                        <b>Wallet connection: </b><br>
                        <span id="walletStatus" style="color:red">Checking for a wallet connection...</span>
                        <button onclick="checkWallet()" id="walletButton" class="btn btn-secondary mt-2">Connect wallet</button>
                    </section>
                    <h3 class="mt-4"><span id="responseMessage" style="color:blue"></span></h3>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.5.0/ethers.umd.min.js" type="application/javascript"></script>
<script src="./mintABI.js" type="text/javascript"></script>

<script>
    // These vars will be used in multiple functions.
    var myWallet;
    var myContract;
    var provider;
    var signer;

    async function checkWallet() {
        // Get wallet addr
        var accountList = await ethereum.request({ method: 'eth_accounts' });
        myWallet = accountList[0];

        // If not connected to wallet, open wallet to connect
        if (!myWallet) {
            await window.ethereum.request({
                method: "eth_requestAccounts", // This checks wallet connection
                params: [{
                    eth_accounts: {}
                }]
            });

            // Reload wallet address
            accountList = await ethereum.request({ method: 'eth_accounts' });
            myWallet = accountList[0];
        };

        // Test again: If not connected to wallet, show a button to allow wallet connection.
        if (!myWallet) {
            document.getElementById('walletStatus').innerHTML = "Click here to connect a crypto wallet: ";
            document.getElementById('walletButton').hidden = false;
        } else {
            document.getElementById('walletStatus').innerHTML = " &#x2713; Your crypto wallet is connected. <br>";
            document.getElementById('walletStatus').style.color = "#0000FF";
            document.getElementById("walletButton").hidden = true;
        };

        contractConnect();
    };

    async function contractConnect() {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        myContract = new ethers.Contract(mintContractAddress, mintABI, provider);
        signer = provider.getSigner();

        // Test the connection by calling data from the contract
        var supply = await myContract.totalSupply();
        console.log("supply=" + supply + " tokenAddr:" + mintContractAddress);
    }

    async function mintTokens() {
        var mintAmount = document.getElementById('tokenAmount').value;
        if (mintAmount <= 0) {
            alert('Please enter a valid number greater than zero.');
            return;
        }

        try {
            const contractWithSigner = myContract.connect(signer);
            const tx = await contractWithSigner.mintFunction(mintAmount);
            const receipt = await tx.wait();
            console.log(`Transaction successful with hash: ${receipt.transactionHash}`);
            document.getElementById('responseMessage').innerHTML = "Tokens minted.";
        } catch (error) {
            console.error("Error calling mintFunction:", error);
            document.getElementById('responseMessage').innerHTML = `Error: ${error.message}`;
        }
    }

    document.getElementById('mintForm').addEventListener('submit', function(event) {
        event.preventDefault();
        mintTokens();
    });
</script>

</body>
</html>
